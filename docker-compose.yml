services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  api-rest:
    build: ./api-rest
    environment:
      REDIS_URL: redis://redis:6379/0
      RATE_LIMIT: ${RATE_LIMIT:-100/minute}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  gateway-graphql:
    build: ./gateway-graphql
    environment:
      REST_BASE_URL: http://api-rest:8080
      GRAPHQL_DEPTH_LIMIT: ${GRAPHQL_DEPTH_LIMIT:-7}
    depends_on:
      api-rest:
        condition: service_healthy
    ports:
      - "4000:4000"
      - "9090:9090"

  ws-events:
    build: ./ws-events
    environment:
      REDIS_URL: redis://redis:6379/0
      WS_ALLOWED_ORIGINS: ${WS_ALLOWED_ORIGINS:-*}
      WS_MESSAGE_RATE_LIMIT: ${WS_MESSAGE_RATE_LIMIT:-10}
      WS_MAX_PAYLOAD:  ${WS_MAX_PAYLOAD:-1048576}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "7070:7070"

  mcp-server-catalog:
    build: ./mcp-server-catalog
    stdin_open: true
    tty: true
    environment:
      REST_BASE_URL: http://api-rest:8080
    depends_on:
      api-rest:
        condition: service_healthy
      redis:
        condition: service_healthy

  mcp-server-orders:
    build: ./mcp-server-orders
    stdin_open: true
    tty: true
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy

  mcp-host:
    build: ./mcp-host
    stdin_open: true
    tty: true
    environment:
      REST_BASE_URL: http://api-rest:8080
      REDIS_URL: redis://redis:6379/0
    depends_on:
      api-rest:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
    - "5000:5000"